(function(e){"use strict";var t=function(t,n){this.options=n;this.table=t;this.currentPage=0;this.currentStart=0;this.filterIndex=[];this.filters=[];this.filterVals=[];this.table.addClass("data-table");if(this.options.nbColumns<0){this.options.nbColumns=this.table.find("thead tr").first().find("th").length}e(this.options.pagingDivSelector).addClass("pagination pagination-centered pagination-data-tables").html("<ul></ul>");var r=this;if(jQuery.isArray(this.options.data)){this.data=this.options.data}else if(jQuery.isPlainObject(this.options.data)){var i=parseInt(this.table.data("size"),10);this.data=[];e(this.options.loadingDivSelector).html('<div class="progress progress-striped active datatable-load-bar"><div class="bar" style="width: 0%;"></div></div>');for(var s=0;s<i;s+=this.options.pageSize*this.options.pagingNumberOfPages){this.getAjaxData(s)}}else{this.data=[];this.table.find("tbody tr").each(function(){var t=[];e(this).find("td").each(function(){t.push(e(this).text())});r.data.push(t)})}if(!jQuery.isFunction(this.options.sort)){var o=0;this.table.find("thead th").each(function(){if(e(this).data("sort")){r.options.sort=true}else if(r.options.sort==="*"){e(this).data("sort",o)}else if(jQuery.isArray(r.options.sort)&&r.options.sort[o]){e(this).data("sort",r.options.sort[o])}if(e(this).data("sort")!==undefined){e(this).addClass("sorting")}o++});this.table.find("thead th").click(function(){if(e(this).data("sort")!==undefined){if(e(this).hasClass("sorting-asc")){r.options.sortDir="desc";e(this).removeClass("sorting-asc").addClass("sorting-desc")}else if(e(this).hasClass("sorting-desc")){r.options.sortDir="asc";e(this).removeClass("sorting-desc").addClass("sorting-asc")}else{e(this).parent("tr").find("th").removeClass("sorting-desc").removeClass("sorting-asc");r.options.sortDir="asc";r.options.sortKey=e(this).data("sort");e(this).addClass("sorting-asc")}r.sort();r.refresh()}})}var u=function(){var e=0;return function(t,n){clearTimeout(e);e=setTimeout(t,n)}}();if(this.options.filters){var a=e("<tr></tr>").insertAfter(this.table.find("thead tr").last());for(var f in this.options.filters){if(this.options.filters[f]){var l=e("<td></td>");if(this.options.filters[f]===true){var c=e('<input type="text" class="search-field" data-sort="'+f+'" />');r.filterVals[f]=c.val();c.keyup(function(t){return function(){var n=e(this).val().toUpperCase();u(function(){r.filterVals[t]=n;r.filter()},300)}}(f));l.append(c);r.addFilter(f,function(e,t){return e.toUpperCase().indexOf(t)!==-1})}else{var h=[],p;if("values"in this.options.filters[f]){h=this.options.filters[f]["values"];p=this.options.filters[f]["default"]}else{h=this.options.filters[f];p=h}var d=e('<select multiple="multiple" class="datatable-select" data-sort="'+f+'"></select>');for(var v in h){d.append('<option value="'+v+'" '+(v in p?"selected":"")+">"+h[v]+"</option>")}r.filterVals[f]=d.val();d.change(function(t){return function(){var n=e(this).val();r.filterVals[t]=n;r.filter()}}(f));l.append(d);r.addFilter(f,function(e,t){if(!t){return false}return t.indexOf(e)!==-1})}a.append(l)}else{a.append("<td></td>")}}}if(jQuery.isFunction(this.options.sort)){this.sort()}else if(this.options.sortKey!==undefined){this.table.each(function(){if(e(this).data("sort")==r.options.sortKey){e(this).trigger("click")}})}this.filter()};t.prototype={updateLoadingDivs:function(){if(this.data.length===size){e(this.options.loadingDivSelector).remove()}else{e(this.options.loadingDivSelector).find("div.progress .bar").css("width",parseInt(100*this.data.length/size,10)+"%")}},getAjaxData:function(t){e.ajax({url:this.options.data.url,type:this.options.data.type,data:{offset:t,limit:this.options.pageSize*this.options.pagingNumberOfPages},ajaxI:t,ajaxThis:this,success:function(t,n,r){this.ajaxThis.data=this.ajaxThis.data.concat(e.parseJSON(t));this.ajaxThis.sort();this.ajaxThis.filter();this.ajaxThis.updateLoadingDivs()},error:function(e,t,n){console.log("Load "+this.ajaxI+" failed: "+t+" (Trying again)");this.ajaxThis.getAjaxData(this.ajaxI)}})},getHead:function(){return this.table.find("thead").first()},getBody:function(){return this.table.find("tbody").first()},getCounter:function(){return e(this.options.counterDivSelector)},getPagingLists:function(){return e(this.options.pagingDivSelector).find("ul")},updatePaging:function(){var t=this.options.pagingNumberOfPages;var n=this;var r=parseInt(this.currentStart/this.options.pageSize,10)+1;var i=parseInt(Math.ceil(this.filterIndex.length/this.options.pageSize),10);var s;var o;if(r<t/2){s=1}else if(r>=i-t/2){s=i-t+1;if(s<1){s=1}}else{s=parseInt(r-t/2+1,10)}if(s+t<i+1){o=s+t-1}else{o=i}this.getPagingLists().each(function(){e(this).html("");e(this).append('<li class="'+(r===1?"active":"")+'"><a data-page="first"><<</a></li>');e(this).append('<li class="'+(r===1?"active":"")+'"><a data-page="prev"><</a></li>');for(var t=s;t<=o;t++){e(this).append('<li class="'+(t===r?"active":"")+'"><a data-page="'+t+'">'+t+"</a></li>")}e(this).append('<li class="'+(r===i||i===0?"active":"")+'"><a data-page="next">></a></li>');e(this).append('<li class="'+(r===i||i===0?"active":"")+'"><a data-page="last">>></a></li>')});this.getPagingLists().find("a").click(function(){if(e(this).parent("li").hasClass("active")){return}var t=e(this).data("page");switch(t){case"first":n.loadPage(1);break;case"prev":n.loadPage(r-1);break;case"next":n.loadPage(r+1);break;case"last":n.loadPage(i);break;default:n.loadPage(parseInt(t,10))}})},updateCounter:function(){var e=this.filterIndex.length?parseInt(this.currentStart/this.options.pageSize,10)+1:0;var t=parseInt(Math.ceil(this.filterIndex.length/this.options.pageSize),10);var n=this.filterIndex.length?this.currentStart+1:0;var r=this.currentStart+this.options.pageSize>this.filterIndex.length?this.filterIndex.length:this.currentStart+this.options.pageSize;this.getCounter().html(this.options.counterText(e,t,n,r,this.filterIndex.length))},getSortFunction:function(){if(jQuery.isFunction(this.options.sort)){return this.options.sort}var e=this.options.sortKey;var t=this.options.sortDir==="asc";return function(n,r){var i=n[e],s=r[e];if(i>s){return t?1:-1}if(i<s){return t?-1:1}return 0}},filter:function(){this.currentStart=0;this.filterIndex=[];for(var e=0;e<this.data.length;e++){if(this.checkFilter(this.data[e])){this.filterIndex.push(e)}}this.refresh()},checkFilter:function(e){var t=true;for(var n in this.filters){if(!this.filters[n](e[n],this.filterVals[n])){t=false;break}}return t},addFilter:function(e,t){this.filters[e]=t},sort:function(){if(!this.options.sort){return}this.data.sort(this.getSortFunction())},addRow:function(e){this.data.push(e);this.sort();this.filter();this.currentStart=parseInt(this.filterIndex.indexOf(this.data.indexOf(e))/this.options.pageSize,10)*this.options.pageSize;this.refresh()},deleteRow:function(e){var t=this.currentStart;this.data.splice(e,1);this.filterIndex.splice(this.filterIndex.indexOf(e),1);this.filter();if(t<this.filterIndex.length){this.currentStart=t}else{this.currentStart=t-this.options.pageSize;if(this.currentStart<0){this.currentStart=0}}this.refresh()},updateRow:function(e,t){this.data.splice(e,1);this.addRow(t)},loadPage:function(e){this.currentStart=(e-1)*this.options.pageSize;this.refresh()},refresh:function(){this.options.beforeRefresh();this.updatePaging();this.updateCounter();this.getBody().html("");if(this.currentStart>=this.currentDataLength){this.getBody().append('<tr><td colspan="'+this.options.nbColumns+'"><div class="progress progress-striped active"><div class="bar" style="width: 100%;"></div></div></div></tr>');return}for(var e=0;e<this.options.pageSize&&e+this.currentStart<this.filterIndex.length;e++){this.getBody().append(this.options.lineFormat(this.filterIndex[this.currentStart+e],this.data[this.filterIndex[this.currentStart+e]]))}this.options.afterRefresh()}};e.fn.datatable=function(){var n=arguments;return this.each(function(){if(n===undefined||e.isPlainObject(n[0])){this.datatable=new t(e(this),e.extend({},e.fn.datatable.defaults,n[0]))}else if(typeof n[0]==="string"){switch(n[0]){case"insert":this.datatable.addRow(n[1]);break;case"update":this.datatable.updateRow(n[1],n[2]);break;case"delete":this.datatable.deleteRow(n[1]);break}}})};e.fn.datatable.defaults={pagingDivSelector:".paging",counterDivSelector:".counter",loadingDivSelector:".loading",sort:false,sortKey:undefined,sortDir:"asc",nbColumns:-1,pageSize:20,pagingSize:10,pagingNumberOfPages:9,counterText:function(e,t,n,r,i){return"Page "+e+"/"+t+". Entrée(s) "+n+" à "+r+" sur un total de "+i+"."},filters:{},beforeRefresh:function(){},afterRefresh:function(){},lineFormat:function(t,n){var r=e("<tr></tr>");for(var i in n){r.append("<td>"+n[i]+"</td>")}return r}}})(window.jQuery)